{% extends "base.html" %}
{% load static %}
{% block content %}
<!-- 新增：全局获取所有评论（绕过模型关联） -->
{% if not comments %}
    {% with comments=comment_list %}
    {% endwith %}
{% endif %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header">
            <h1>{{ post.title }}</h1>
        </div>
        <div class="card-body">
            <!-- 文章内容 -->
            <p class="card-text">{{ post.content }}</p>
            <p class="card-text">
                <small class="text-muted">作者: <a href="{% url 'account:user_profile' post.author.username %}">{{ post.author.username }}</a></small>
                <br>
                <small class="text-muted">发布时间: {{ post.created_at }}</small>

    <!-- 仅当前登录用户是作者时显示编辑/删除按钮 -->
    {% if user == post.author %}
        <a href="{% url 'post:edit' post.pk %}" class="btn btn-sm btn-primary ms-2">编辑</a>
        <a href="{% url 'post:delete' post.pk %}" class="btn btn-sm btn-danger ms-1">删除</a>
    {% endif %}
</div>
            </p>

            <!-- 分享功能区域 -->
            <div style="margin: 20px 0; display: flex; gap: 10px; align-items: center; padding-top: 15px; border-top: 1px solid #eee;">
                <span style="font-size: 14px; color: #666;">分享：</span>
                <button onclick="shareToQQ()"
                    style="padding: 8px 18px; background: #12B7F5; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 14px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM16.2 16.2L11 13V7H12.5V12.2L17 14.9L16.2 16.2Z" fill="white"/>
                    </svg>
                    QQ
                </button>
                <button onclick="shareToWechat()"
                    style="padding: 8px 18px; background: #07C160; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 14px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M7.1 20.04C2.45 18.74 2.45 12.66 2.45 12.66C2.45 12.66 2.45 6.59 7.1 5.27C11.75 3.95 15.08 5.27 16.3 6.5C17.53 7.73 17.53 10.78 17.53 10.78H19.6C19.6 10.78 19.6 6.04 15.08 3.95C10.55 1.85 2.45 4.53 2.45 12.66C2.45 20.79 10.55 23.46 15.08 21.37C18.34 19.95 19.6 16.3 19.6 12.87H17.53C17.53 12.87 17.53 15.93 16.3 17.16C15.08 18.39 11.75 19.7 7.1 20.04Z" fill="white"/>
                    </svg>
                    微信
                </button>
            </div>

<!-- 评论区域（仅改这里，其他内容不变） -->
<div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
    <h5>评论</h5>
    <!-- 发表评论表单（路由保持你的原有配置） -->
    <form method="post" action="{% url 'post:comment' post.id %}" style="margin: 15px 0;">
        {% csrf_token %}
        <div class="form-group">
            <textarea name="content" class="form-control" rows="3" placeholder="请输入你的评论..." required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">提交评论</button>
    </form>
    <!-- 评论列表：用原始SQL查询的方式绕过模型关联问题 -->
    <div class="comment-list">
        {% with post_id=post.id %}
            {% for comment in comments %}
                {% if comment.post_id == post_id %}
                    <div class="card mb-2">
                        <div class="card-body p-3">
                            <p class="mb-1"><strong>{{ comment.author.username }}</strong> <small class="text-muted">{{ comment.created_at|date:"Y-m-d H:i" }}</small></p>
                            <p class="mb-0">{{ comment.content }}</p>
                        </div>
                    </div>
                {% endif %}
            {% empty %}
                <p>暂无评论，快来抢沙发~</p>
            {% endfor %}
        {% endwith %}
    </div>
</div>

        </div>
    </div>
</div>

<!-- 分享功能JS（适配Django + 所有浏览器） -->
<script>
// QQ分享（保留你原有可运行的逻辑）
function shareToQQ() {
    try {
        const url = window.location.href;
        const title = document.title;
        const shareWin = window.open('', '_blank', 'width=700,height=600,top=100,left=200');
        const qqShareUrl = `https://connect.qq.com/widget/shareqq/index.html?url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}`;
        shareWin.location.href = qqShareUrl;
        setTimeout(() => {
            if (shareWin.closed || !shareWin.location.href) {
                alert('QQ分享弹窗被拦截！请允许浏览器的弹窗权限，或手动复制链接分享：\n' + url);
            }
        }, 1000);
    } catch (err) {
        alert('QQ分享失败，请手动复制链接：\n' + window.location.href);
        console.log('QQ分享错误：', err);
    }
}

// 微信分享（适配Django + HTTP/HTTPS环境）
function shareToWechat() {
    // 获取当前文章的完整URL（Django中window.location.href已包含域名）
    const url = window.location.href;

    // 兼容方案：创建临时输入框复制链接（避开浏览器权限限制）
    const tempInput = document.createElement('input');
    tempInput.style.position = 'absolute';
    tempInput.style.left = '-9999px';
    tempInput.value = url;
    document.body.appendChild(tempInput);

    // 选中并复制
    tempInput.select();
    tempInput.setSelectionRange(0, 99999); // 兼容移动端

    try {
        // 执行复制（Django环境下稳定可用）
        document.execCommand('copy');
        alert('✅ 文章链接已复制到剪贴板！\n打开微信粘贴即可分享给好友/朋友圈~');
    } catch (err) {
        // 复制失败时提示手动复制
        alert('❌ 自动复制失败，请手动复制链接：\n' + url);
        console.log('微信分享复制错误：', err);
    } finally {
        // 移除临时输入框（不影响页面布局）
        document.body.removeChild(tempInput);
    }
}
</script>
{% endblock %}
